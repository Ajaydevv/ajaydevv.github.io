var i=(t,r,s)=>new Promise((o,a)=>{var x=n=>{try{p(s.next(n))}catch(u){a(u)}},y=n=>{try{p(s.throw(n))}catch(u){a(u)}},p=n=>n.done?o(n.value):Promise.resolve(n.value).then(x,y);p((s=s.apply(t,r)).next())});import{j as e}from"./ui-CdYL37x2.js";import{r as h}from"./vendor-BcaInPIV.js";import{s as l,u as q,b as U,d as k,a as b,I,e as d}from"./index-CKkHQYAn.js";import{C as g,b as j,c as w,d as S,a as v}from"./card-B_G0rC3P.js";import{L as E}from"./label-BFXH3_ed.js";import{T as F}from"./textarea-S-6pdMz9.js";import{s as R}from"./database-BCflSPiJ.js";import"./supabase-cZfeQMuK.js";const L={getProfile(t){return i(this,null,function*(){const{data:r,error:s}=yield l.from("profiles").select("*").eq("id",t).single();if(s&&s.code!=="PGRST116")throw s;return r})},isUserAdmin(t){return i(this,null,function*(){try{const r=new Promise((x,y)=>setTimeout(()=>y(new Error("Admin check timeout")),8e3)),s=l.from("profiles").select("is_admin").eq("id",t).single(),{data:o,error:a}=yield Promise.race([s,r]);if(a&&a.code!=="PGRST116")throw a;return(o==null?void 0:o.is_admin)||!1}catch(r){return console.error("Error checking admin status:",r),!1}})},isCurrentUserAdmin(){return i(this,null,function*(){const{data:{user:t}}=yield l.auth.getUser();return t?this.isUserAdmin(t.id):!1})},updateProfile(t,r){return i(this,null,function*(){const{data:s,error:o}=yield l.from("profiles").update(r).eq("id",t).select().single();if(o)throw o;return s})},grantAdminStatus(t){return i(this,null,function*(){const{error:r}=yield l.from("profiles").update({is_admin:!0}).eq("id",t);if(r)throw r})},revokeAdminStatus(t){return i(this,null,function*(){const{error:r}=yield l.from("profiles").update({is_admin:!1}).eq("id",t);if(r)throw r})},getAllProfiles(){return i(this,null,function*(){const{data:t,error:r}=yield l.from("profiles").select("*").order("created_at",{ascending:!1});if(r)throw r;return t||[]})},getAdminUsers(){return i(this,null,function*(){const{data:t,error:r}=yield l.from("profiles").select("*").eq("is_admin",!0).order("created_at",{ascending:!1});if(r)throw r;return t||[]})}};function Y(){const[t,r]=h.useState(""),[s,o]=h.useState(""),[a,x]=h.useState(!1),[y,p]=h.useState(!0),[n,u]=h.useState(!1),{user:m}=q(),C=U();h.useEffect(()=>{i(this,null,function*(){if(m)try{const c=new Promise((N,_)=>setTimeout(()=>_(new Error("Admin check timeout")),1e4)),P=L.isUserAdmin(m.id),A=yield Promise.race([P,c]);u(A)}catch(c){console.error("Error checking admin status:",c),u(!1),d.error("Failed to verify admin status. Please try again.")}p(!1)})},[m]);const T=f=>i(this,null,function*(){if(f.preventDefault(),!m){d.error("You must be logged in to create a story");return}if(!n){d.error("Only administrators can create stories");return}if(!t.trim()||!s.trim()){d.error("Please fill in both title and content");return}x(!0);try{const c=new Promise((A,N)=>setTimeout(()=>N(new Error("Story creation timeout")),3e4)),P=R.createStory({title:t.trim(),content:s.trim()},m.id,m.name);yield Promise.race([P,c]),d.success("Story created successfully!"),C("/stories")}catch(c){console.error("Error creating story:",c),c instanceof Error&&c.message==="Story creation timeout"?d.error("Story creation is taking too long. Please try again."):d.error("Failed to create story. Please check your connection and try again.")}finally{x(!1)}});return y?e.jsxs(g,{className:"w-full max-w-2xl mx-auto",children:[e.jsxs(j,{children:[e.jsx(w,{children:"Create a Story"}),e.jsx(S,{children:"Checking permissions..."})]}),e.jsxs(v,{className:"flex items-center justify-center py-8",children:[e.jsx(k,{className:"h-6 w-6 animate-spin"}),e.jsx("span",{className:"ml-2 text-muted-foreground",children:"Verifying admin access..."})]})]}):m?n?e.jsxs(g,{className:"w-full max-w-2xl mx-auto",children:[e.jsxs(j,{children:[e.jsx(w,{children:"Create a New Story"}),e.jsx(S,{children:"Share your story with the community."})]}),e.jsx(v,{children:e.jsxs("form",{onSubmit:T,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"title",children:"Story Title"}),e.jsx(I,{id:"title",type:"text",placeholder:"Enter your story title...",value:t,onChange:f=>r(f.target.value),disabled:a,required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(E,{htmlFor:"content",children:"Story Content"}),e.jsx(F,{id:"content",placeholder:"Write your story here...",value:s,onChange:f=>o(f.target.value),disabled:a,rows:10,required:!0})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(b,{type:"submit",disabled:a,children:[a&&e.jsx(k,{className:"h-4 w-4 animate-spin mr-2"}),a?"Creating...":"Create Story"]}),e.jsx(b,{type:"button",variant:"outline",onClick:()=>C("/stories"),disabled:a,children:"Cancel"})]})]})})]}):e.jsxs(g,{className:"w-full max-w-2xl mx-auto",children:[e.jsxs(j,{children:[e.jsx(w,{children:"Access Restricted"}),e.jsx(S,{children:"Only administrators can create stories."})]}),e.jsxs(v,{className:"text-center py-8",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"You don't have permission to create stories. Please contact an administrator for access."}),e.jsx(b,{onClick:()=>C("/stories"),variant:"outline",children:"View Stories Instead"})]})]}):e.jsx(g,{className:"w-full max-w-2xl mx-auto",children:e.jsxs(j,{children:[e.jsx(w,{children:"Create a Story"}),e.jsx(S,{children:"You must be logged in to create a story."})]})})}function K(){return e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsx(Y,{})})}export{K as CreateStory};
